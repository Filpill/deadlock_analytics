<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Analytics - {{ player_id }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="A comprehensive web-based analytics platform for Deadlock game statistics. View detailed player performance metrics, match history, hero statistics, and interactive visualisations.">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Player Analytics - {{ player_id }}">
    <meta property="og:description" content="A comprehensive web-based analytics platform for Deadlock game statistics. View detailed player performance metrics, match history, hero statistics, and interactive visualisations.">
    <meta property="og:image" content="https://deadlock-analytics-164941517977.europe-west2.run.app/static/img/yt_deadlock.png">
    <meta property="og:url" content="https://deadlock-analytics-164941517977.europe-west2.run.app/analyze?player_id={{ player_id }}">
    <meta property="og:type" content="website">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Player Analytics - {{ player_id }}">
    <meta name="twitter:description" content="A comprehensive web-based analytics platform for Deadlock game statistics. View detailed player performance metrics, match history, hero statistics, and interactive visualisations.">
    <meta name="twitter:image" content="https://deadlock-analytics-164941517977.europe-west2.run.app/static/img/yt_deadlock.png">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Applying filter...</div>
    </div>
    <div class="container">
        <div class="header">
            {% if steam_data and steam_data.avatar_full %}
            <div class="player-profile">
                <img src="{{ steam_data.avatar_full }}" alt="Player Avatar" class="player-avatar">
                <div class="player-info">
                    <div class="player-username">
                        {{ steam_data.username }}
                        {% if steam_data.rank_badge %}
                        <img src="{{ steam_data.rank_badge }}" alt="{{ steam_data.rank_name }}" class="rank-badge" title="{{ steam_data.rank_name }}{% if steam_data.rank_division_tier %} {{ steam_data.rank_division_tier }}{% endif %}">
                        {% endif %}
                    </div>
                    <p class="player-steam-id">Steam ID: <span>{{ player_id }}</span></p>
                </div>
            </div>
            {% endif %}
            <img src="/static/img/deadlock-logo-no-title-flat.png" alt="Deadlock" class="dashboard-logo">
            <div class="back-button-container">
                <a href="/" class="back-button">Analyze Another Player</a>
            </div>
        </div>

        {% if summary %}
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Matches</h3>
                <div class="value">{{ summary.total_matches }}</div>
            </div>
            <div class="summary-card">
                <h3>Wins</h3>
                <div class="value" style="color: #5cc85c;">{{ summary.wins }}</div>
            </div>
            <div class="summary-card">
                <h3>Losses</h3>
                <div class="value" style="color: #d94040;">{{ summary.losses }}</div>
            </div>
            <div class="summary-card win-rate">
                <h3>Win Rate</h3>
                <div class="value">{{ summary.win_rate }}</div>
            </div>
            {% if summary.avg_kills and summary.avg_deaths and summary.avg_assists %}
            <div class="summary-card">
                <h3>Avg K / D / A</h3>
                <div class="kda-values">
                    <span class="value" style="color: #5cc85c;">{{ summary.avg_kills }}</span>
                    <span class="separator">/</span>
                    <span class="value" style="color: #d94040;">{{ summary.avg_deaths }}</span>
                    <span class="separator">/</span>
                    <span class="value" style="color: #66c0f4;">{{ summary.avg_assists }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if top_heroes %}
        <div class="top-heroes-container">
            <div class="top-heroes-section">
                <h2 class="top-heroes-title">
                    <span>Top 5 Heroes by Games Played</span>
                    {% if filtered_hero_name %}
                    <span class="filter-badge">Viewing: {{ filtered_hero_name }}</span>
                    <a href="/analyze?player_id={{ player_id }}" class="clear-filter-btn">Clear Filter</a>
                    {% endif %}
                </h2>
                <div class="top-heroes-grid">
                    {% for hero in top_heroes %}
                    <a href="/analyze?player_id={{ player_id }}&hero_id={{ hero.hero_id }}"
                       class="hero-card {% if hero_id == hero.hero_id %}hero-card-selected{% endif %}">
                        {% if hero.icon_url %}
                        <img src="{{ hero.icon_url }}" alt="{{ hero.name }}" class="hero-icon">
                        {% endif %}
                        <div class="hero-name">{{ hero.name }}</div>
                        <div class="hero-stats">
                            <div class="hero-stat">
                                <div class="hero-stat-label">Matches</div>
                                <div class="hero-stat-value">{{ hero.matches }}</div>
                            </div>
                            <div class="hero-stat">
                                <div class="hero-stat-label">Win Rate</div>
                                <div class="hero-stat-value">{{ hero.win_rate }}</div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Matches Table -->
        {% if recent_matches %}
        <div class="chart-container">
            <div class="matches-header">
                <h3 class="chart-title">Match History</h3>
                {% if filtered_hero_name %}
                <p class="filter-subtitle">Filter Applied: <span class="filter-hero-name">{{ filtered_hero_name }}</span></p>
                {% endif %}
            </div>
            <table class="recent-matches-table">
                <thead>
                    <tr>
                        <th>Match ID</th>
                        <th>Date</th>
                        <th>Hero</th>
                        <th>Result</th>
                        <th>K</th>
                        <th>D</th>
                        <th>A</th>
                        <th>Net Worth</th>
                        <th>Last Hits</th>
                        <th>Denies</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="matchesTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            <div class="pagination-controls-bottom">
                <button id="prevPage" class="pagination-btn" disabled>&laquo; Previous</button>
                <span id="pageInfo" class="page-info">Page 1 of 1</span>
                <button id="nextPage" class="pagination-btn" disabled>Next &raquo;</button>
            </div>
        </div>

        <script>
            // Match history pagination
            const allMatches = {{ recent_matches | tojson }};
            const matchesPerPage = 5;
            let currentPage = 1;
            const totalPages = Math.ceil(allMatches.length / matchesPerPage);
            let tableSoundCounter = 1; // Counter for sequential tile sounds

            function renderMatches(page) {
                const start = (page - 1) * matchesPerPage;
                const end = start + matchesPerPage;
                const matchesToShow = allMatches.slice(start, end);

                const tbody = document.getElementById('matchesTableBody');
                tbody.innerHTML = '';

                matchesToShow.forEach(match => {
                    const row = document.createElement('tr');
                    row.className = match.result === 'Win' ? 'match-win' : 'match-loss';

                    // Format date from Unix timestamp
                    const date = new Date(match.start_time * 1000);
                    const dateStr = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    row.innerHTML = `
                        <td class="stat-matchid">${match.match_id}</td>
                        <td class="stat-date">${dateStr}</td>
                        <td class="hero-name-cell">
                            ${match.hero_icon ? `<img src="${match.hero_icon}" alt="${match.hero_name}" class="hero-icon-sm">` : ''}
                            <span>${match.hero_name}</span>
                        </td>
                        <td class="match-result ${match.result === 'Win' ? 'result-win' : 'result-loss'}">${match.result}</td>
                        <td class="stat-kills">${match.kills}</td>
                        <td class="stat-deaths">${match.deaths}</td>
                        <td class="stat-assists">${match.assists}</td>
                        <td class="stat-networth">${match.net_worth.toLocaleString()}</td>
                        <td class="stat-lasthits">${match.last_hits}</td>
                        <td class="stat-denies">${match.denies}</td>
                        <td class="stat-duration">${Math.floor(match.duration_s / 60)}:${String(match.duration_s % 60).padStart(2, '0')}</td>
                    `;

                    // Add click handler to play tile sound
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function() {
                        // Wait for audio data to load if not ready
                        if (!soundsData || !soundsData.player || !soundsData.player.footsteps) {
                            console.log('Audio data not ready yet');
                            return;
                        }

                        // Navigate to player.footsteps.shared.surface_sweeteners.soft_impact
                        const footsteps = soundsData.player.footsteps;
                        if (!footsteps.shared || !footsteps.shared.surface_sweeteners || !footsteps.shared.surface_sweeteners.soft_impact) {
                            console.log('Footstep sounds not found in expected path');
                            return;
                        }

                        const softImpactSounds = footsteps.shared.surface_sweeteners.soft_impact;

                        // Find the tile sound with current counter number (two-digit format)
                        const soundKey = `tile_${String(tableSoundCounter).padStart(2, '0')}`;
                        const soundUrl = softImpactSounds[soundKey];

                        if (!soundUrl) {
                            console.log('Tile sound not found:', soundKey);
                            return;
                        }

                        console.log('Playing tile sound:', soundKey);
                        const audio = new Audio(soundUrl);
                        audio.volume = 0.5;
                        audio.play()
                            .then(() => {
                                console.log('Table row sound started playing!');
                                // Increment counter
                                tableSoundCounter++;
                                if (tableSoundCounter > 14) {
                                    tableSoundCounter = 1; // Reset to 1
                                }
                            })
                            .catch(err => console.error('Failed to play table row sound:', err));
                    });

                    tbody.appendChild(row);
                });

                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;

                // Update button states
                document.getElementById('prevPage').disabled = page === 1;
                document.getElementById('nextPage').disabled = page === totalPages;
            }

            function playPaginationSound() {
                const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_shop_click_vitality.mp3';
                const audio = new Audio(soundUrl);
                audio.volume = 0.5;
                audio.play().catch(err => console.error('Pagination sound failed to play:', err));
            }

            function changePage(delta) {
                playPaginationSound();
                currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
                renderMatches(currentPage);
            }

            // Initialize pagination
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));

            // Render first page
            renderMatches(1);
        </script>
        {% endif %}

        {% if charts %}
            {% if charts.win_loss_timeline %}
            <div class="chart-container">
                <div id="chart1"></div>
            </div>
            {% endif %}

            {% if charts.performance_curve %}
            <div class="chart-container">
                <div id="chart3"></div>
            </div>
            {% endif %}

            {% if charts.percentile_dist %}
            <div class="chart-container">
                <div id="chart4_5"></div>
            </div>
            {% endif %}

            {% if charts.kda_trend %}
            <div class="chart-container">
                <div id="chart6"></div>
            </div>
            {% endif %}

            {% if charts.kd_stats or top_items %}
            <div class="chart-row">
                <!-- Left column: Kill/Death Map -->
                {% if charts.kd_stats %}
                <div class="chart-container">
                    <div id="chart4"></div>
                </div>
                {% endif %}

                <!-- Right column: Top 10 Items Table -->
                {% if top_items %}
                <div class="chart-container">
                    <h3 class="chart-title">Top 10 Items Played</h3>
                    {% if filtered_hero_name %}
                    <p class="filter-subtitle">Filter Applied: <span class="filter-hero-name">{{ filtered_hero_name }}</span></p>
                    {% endif %}
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Matches</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in top_items %}
                            <tr>
                                <td class="item-name-cell">
                                    {% if item.icon_url %}
                                    <img src="{{ item.icon_url }}" alt="{{ item.name }}" class="item-icon">
                                    {% endif %}
                                    <span>{{ item.name }}</span>
                                </td>
                                <td class="item-matches">{{ item.matches }}</td>
                                <td class="item-winrate">{{ item.win_rate }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if charts.hero_heatmap %}
            <div class="chart-container">
                <div id="chart8"></div>
            </div>
            {% endif %}

            {% if charts.mmr_history %}
            <div class="chart-container">
                <div id="chart7"></div>
            </div>
            {% endif %}
        {% else %}
            <div class="chart-container">
                <p class="no-data">No chart data available</p>
            </div>
        {% endif %}
    </div>

    <script>
        // Deep merge function to preserve existing properties
        function deepMerge(target, source) {
            for (let key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = target[key] || {};
                    deepMerge(target[key], source[key]);
                } else if (source[key] !== undefined) {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // Apply Steam theme to a chart layout
        function applySteamTheme(layout, darkBg) {
            // Preserve existing title text, only update styling
            if (layout.title) {
                if (typeof layout.title === 'string') {
                    layout.title = {
                        text: layout.title,
                        font: { color: '#66c0f4', size: 22 }
                    };
                } else if (layout.title.text) {
                    layout.title.font = { color: '#66c0f4', size: 22 };
                }
            }

            // Apply base styling
            layout.paper_bgcolor = 'rgba(27, 40, 56, 0)';
            layout.plot_bgcolor = darkBg ? 'rgba(22, 32, 45, 0.8)' : 'rgba(22, 32, 45, 0.4)';

            layout.font = layout.font || {};
            layout.font.family = 'Motiva Sans, Arial, sans-serif';
            layout.font.color = '#c7d5e0';
            layout.font.size = 12;

            // Apply axis styling (preserve existing axis properties)
            ['xaxis', 'yaxis', 'yaxis2'].forEach(function(axis) {
                if (layout[axis]) {
                    layout[axis].gridcolor = '#3d4e5c';
                    layout[axis].linecolor = '#3d4e5c';
                    layout[axis].zerolinecolor = '#3d4e5c';
                    layout[axis].tickfont = layout[axis].tickfont || {};
                    layout[axis].tickfont.color = '#8f98a0';

                    // Preserve title styling
                    if (layout[axis].title) {
                        if (typeof layout[axis].title === 'string') {
                            layout[axis].title = {
                                text: layout[axis].title,
                                font: { color: '#c7d5e0' }
                            };
                        } else if (layout[axis].title.text) {
                            layout[axis].title.font = layout[axis].title.font || {};
                            layout[axis].title.font.color = '#c7d5e0';
                        }
                    }
                }
            });

            // Apply legend styling
            if (layout.legend) {
                layout.legend.bgcolor = 'rgba(27, 40, 56, 0.9)';
                layout.legend.bordercolor = '#3d4e5c';
                layout.legend.borderwidth = 1;
                layout.legend.font = layout.legend.font || {};
                layout.legend.font.color = '#c7d5e0';
            }

            return layout;
        }

        {% if charts %}
            {% if charts.win_loss_timeline %}
            var chart1 = {{ charts.win_loss_timeline | safe }};
            applySteamTheme(chart1.layout, false);
            Plotly.newPlot('chart1', chart1.data, chart1.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.performance_curve %}
            var chart3 = {{ charts.performance_curve | safe }};
            applySteamTheme(chart3.layout, false);
            Plotly.newPlot('chart3', chart3.data, chart3.layout, {displayModeBar: true, displaylogo: false, responsive: true});
            {% endif %}

            {% if charts.kd_stats %}
            var chart4 = {{ charts.kd_stats | safe }};
            applySteamTheme(chart4.layout, true);  // Darker background for map
            Plotly.newPlot('chart4', chart4.data, chart4.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.percentile_dist %}
            var chart4_5 = {{ charts.percentile_dist | safe }};
            applySteamTheme(chart4_5.layout, false);
            Plotly.newPlot('chart4_5', chart4_5.data, chart4_5.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.kda_trend %}
            var chart6 = {{ charts.kda_trend | safe }};
            applySteamTheme(chart6.layout, false);
            Plotly.newPlot('chart6', chart6.data, chart6.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.mmr_history %}
            var chart7 = {{ charts.mmr_history | safe }};
            applySteamTheme(chart7.layout, false);
            Plotly.newPlot('chart7', chart7.data, chart7.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.hero_heatmap %}
            var chart8 = {{ charts.hero_heatmap | safe }};
            applySteamTheme(chart8.layout, false);
            Plotly.newPlot('chart8', chart8.data, chart8.layout, {displayModeBar: true, displaylogo: false});

            // Store original full dataset for filtering
            var chart8OriginalData = {
                z: JSON.parse(JSON.stringify(chart8.data[0].z)),
                text: JSON.parse(JSON.stringify(chart8.data[0].text)),
                y: JSON.parse(JSON.stringify(chart8.data[0].y)),
                customdata: JSON.parse(JSON.stringify(chart8.data[0].customdata)),
                images: JSON.parse(JSON.stringify(chart8.layout.images || [])),
                annotations: JSON.parse(JSON.stringify(chart8.layout.annotations || []))
            };

            // The last annotation is the filter label, separate it from hero annotations
            var filterLabelAnnotation = chart8OriginalData.annotations[chart8OriginalData.annotations.length - 1];
            var heroAnnotations = chart8OriginalData.annotations.slice(0, -1);
            chart8OriginalData.heroAnnotations = heroAnnotations;

            // Add button click handler for filtering by minimum matches
            document.getElementById('chart8').on('plotly_buttonclicked', function(data) {
                var threshold = data.button.args[0];
                console.log('Filtering heroes with >= ' + threshold + ' matches');

                // Filter data based on threshold
                var filtered = [];
                for (var i = 0; i < chart8OriginalData.y.length; i++) {
                    var matches = chart8OriginalData.customdata[i][0];
                    if (matches >= threshold) {
                        filtered.push({
                            hero: chart8OriginalData.y[i],
                            zRow: chart8OriginalData.z[i],
                            textRow: chart8OriginalData.text[i],
                            customdataRow: chart8OriginalData.customdata[i],
                            image: chart8OriginalData.images[i] || null,
                            annotation: chart8OriginalData.heroAnnotations[i] || null,
                            matches: matches
                        });
                    }
                }

                // Extract filtered data
                var newZ = [];
                var newText = [];
                var newY = [];
                var newCustomdata = [];
                var newImages = [];
                var newAnnotations = [];

                for (var i = 0; i < filtered.length; i++) {
                    newZ.push(filtered[i].zRow);
                    newText.push(filtered[i].textRow);
                    newY.push(filtered[i].hero);
                    newCustomdata.push(filtered[i].customdataRow);
                    if (filtered[i].image) {
                        var updatedImage = Object.assign({}, filtered[i].image);
                        updatedImage.y = i;
                        newImages.push(updatedImage);
                    }
                    if (filtered[i].annotation) {
                        var updatedAnnotation = Object.assign({}, filtered[i].annotation);
                        updatedAnnotation.y = i;
                        newAnnotations.push(updatedAnnotation);
                    }
                }

                // Add filter label annotation at the end
                newAnnotations.push(filterLabelAnnotation);

                // Update chart
                Plotly.update('chart8', {
                    z: [newZ],
                    text: [newText],
                    y: [newY],
                    customdata: newCustomdata
                }, {
                    images: newImages,
                    annotations: newAnnotations,
                    'yaxis.tickvals': Array.from({length: newY.length}, function(_, i) { return i; }),
                    'yaxis.ticktext': Array(newY.length).fill(''),
                    height: Math.max(800, newY.length * 40),
                    'title.text': 'Hero Performance Heatmap (Min ' + threshold + ' matches)'
                });
            });

            // Add click handler for sorting by metric (click anywhere in a column to sort by that metric)
            document.getElementById('chart8').on('plotly_click', function(data) {
                var clickedPoint = data.points[0];
                var metricIndex = clickedPoint.pointIndex[1];  // Column index (x position)
                var metricName = chart8.data[0].x[metricIndex];

                console.log('Clicked metric:', metricName, 'at index:', metricIndex);

                // Get current data from the actual chart (might be filtered)
                Plotly.Fx.hover('chart8', []);  // Clear hover
                var currentData = document.getElementById('chart8').data[0];
                var currentLayout = document.getElementById('chart8').layout;

                var currentZ = currentData.z;
                var currentText = currentData.text;
                var currentY = currentData.y;
                var currentCustomdata = currentData.customdata || [];
                var currentImages = currentLayout.images || [];
                var currentAnnotations = currentLayout.annotations || [];

                // Separate hero annotations from label annotation (last one)
                var currentHeroAnnotations = currentAnnotations.slice(0, -1);
                var currentLabelAnnotation = currentAnnotations[currentAnnotations.length - 1];

                // Create array with all row data for sorting
                var sortData = [];
                for (var i = 0; i < currentY.length; i++) {
                    sortData.push({
                        hero: currentY[i],
                        value: currentZ[i][metricIndex],
                        zRow: currentZ[i],
                        textRow: currentText[i],
                        customdataRow: currentCustomdata[i] || [0],
                        image: currentImages[i] || null,
                        annotation: currentHeroAnnotations[i] || null
                    });
                }

                // Sort by clicked metric (descending - highest first)
                sortData.sort(function(a, b) {
                    return b.value - a.value;
                });

                // Extract sorted data
                var newZ = [];
                var newText = [];
                var newY = [];
                var newCustomdata = [];
                var newImages = [];
                var newAnnotations = [];

                for (var i = 0; i < sortData.length; i++) {
                    newZ.push(sortData[i].zRow);
                    newText.push(sortData[i].textRow);
                    newY.push(sortData[i].hero);
                    newCustomdata.push(sortData[i].customdataRow);
                    if (sortData[i].image) {
                        var updatedImage = Object.assign({}, sortData[i].image);
                        updatedImage.y = i;
                        newImages.push(updatedImage);
                    }
                    if (sortData[i].annotation) {
                        var updatedAnnotation = Object.assign({}, sortData[i].annotation);
                        updatedAnnotation.y = i;
                        newAnnotations.push(updatedAnnotation);
                    }
                }

                // Add filter label annotation at the end
                newAnnotations.push(currentLabelAnnotation);

                // Update chart
                Plotly.update('chart8', {
                    z: [newZ],
                    text: [newText],
                    y: [newY],
                    customdata: newCustomdata
                }, {
                    images: newImages,
                    annotations: newAnnotations,
                    'yaxis.tickvals': Array.from({length: newY.length}, function(_, i) { return i; }),
                    'yaxis.ticktext': Array(newY.length).fill(''),
                    'title.text': 'Hero Performance Heatmap (Sorted by ' + metricName + ')'
                });
            });
            {% endif %}
        {% endif %}

        // Fetch sounds data and play voicelines when hero is selected
        let soundsData = null;
        let heroesData = null;

        // Fetch sounds and heroes data on page load
        async function loadAudioData() {
            try {
                console.log('Loading audio data...');
                const [soundsResponse, heroesResponse] = await Promise.all([
                    fetch('https://assets.deadlock-api.com/v1/sounds'),
                    fetch('https://assets.deadlock-api.com/v2/heroes')
                ]);
                soundsData = await soundsResponse.json();
                heroesData = await heroesResponse.json();
                console.log('Audio data loaded successfully');
                console.log('Heroes count:', heroesData.length);
                console.log('Sounds has vo key:', 'vo' in soundsData);
                if (soundsData.vo) {
                    console.log('VO hero classes:', Object.keys(soundsData.vo).slice(0, 5));
                }
            } catch (error) {
                console.error('Failed to load audio data:', error);
            }
        }

        // Play random select voiceline for a hero (returns a promise that resolves when audio finishes)
        function playHeroSelectSound(heroId) {
            return new Promise((resolve, reject) => {
            console.log('=== playHeroSelectSound called with heroId:', heroId);
                console.log('soundsData exists:', !!soundsData);
                console.log('heroesData exists:', !!heroesData);

                if (!soundsData || !heroesData) {
                    console.log('Audio data not loaded yet');
                    resolve(); // Resolve immediately if no audio data
                    return;
                }

                // Find hero by ID
                console.log('Searching for hero with id:', heroId);
                console.log('First 3 heroes:', heroesData.slice(0, 3).map(h => ({id: h.id, name: h.name})));
                const hero = heroesData.find(h => h.id === heroId);

                if (!hero) {
                    console.log('Hero not found for id:', heroId);
                    console.log('Available hero IDs:', heroesData.map(h => h.id).slice(0, 10));
                    resolve(); // Resolve immediately if hero not found
                    return;
                }

            let heroClassName = hero.class_name;
            console.log('Found hero:', hero.name, 'class_name:', heroClassName);

            // Remove "hero_" prefix if present (sounds API doesn't use the prefix)
            if (heroClassName.startsWith('hero_')) {
                heroClassName = heroClassName.substring(5); // Remove "hero_" prefix
                console.log('Stripped to:', heroClassName);
            }

            // Get voicelines for this hero
            const voSounds = soundsData.vo || {};
            console.log('VO sounds available:', Object.keys(voSounds).length);
            console.log('Looking for class_name:', heroClassName);
            const heroSounds = voSounds[heroClassName];

                if (!heroSounds) {
                    console.log('No sounds found for hero class:', heroClassName);
                    console.log('Available classes:', Object.keys(voSounds).slice(0, 10));
                    resolve(); // Resolve immediately if no sounds
                    return;
                }

                console.log('Hero sounds found:', Object.keys(heroSounds).length, 'total sounds');

                // Filter for select sounds
                const selectSounds = Object.entries(heroSounds).filter(([key, url]) =>
                    key.toLowerCase().includes('_select_')
                );

                console.log('Select sounds found:', selectSounds.length);

                if (selectSounds.length === 0) {
                    console.log('No select sounds found for:', heroClassName);
                    resolve(); // Resolve immediately if no select sounds
                    return;
                }

                // Pick random select sound
                const randomSound = selectSounds[Math.floor(Math.random() * selectSounds.length)];
                const [soundKey, soundUrl] = randomSound;

                console.log('Selected sound:', soundKey);
                console.log('Sound URL:', soundUrl);

                // Play the audio
                const audio = new Audio(soundUrl);
                audio.volume = globalVolume;

                // Resolve when audio ends
                audio.addEventListener('ended', () => {
                    console.log('Audio finished playing!');
                    resolve();
                });

                // Reject on error
                audio.addEventListener('error', (err) => {
                    console.error('Audio error:', err);
                    resolve(); // Still resolve to allow navigation
                });

                console.log('Attempting to play audio...');
                audio.play()
                    .then(() => console.log('Audio started playing successfully!'))
                    .catch(err => {
                        console.error('Audio play failed:', err);
                        resolve(); // Resolve even on play failure
                    });
            });
        }

        // Play UI sound when data is fetched (returns a promise that resolves when audio finishes)
        function playDataFetchedSound() {
            return new Promise((resolve, reject) => {
                const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_hud_acquire_ap_02.mp3';
                const audio = new Audio(soundUrl);
                audio.volume = globalVolume;

                // Resolve when audio ends
                audio.addEventListener('ended', () => {
                    console.log('UI sound finished playing!');
                    resolve();
                });

                // Reject on error
                audio.addEventListener('error', (err) => {
                    console.error('UI sound error:', err);
                    resolve(); // Still resolve to allow navigation
                });

                console.log('Playing UI sound from:', soundUrl);
                audio.play()
                    .then(() => console.log('UI sound started playing successfully!'))
                    .catch(err => {
                        console.error('Failed to play UI sound:', err);
                        resolve(); // Resolve even on play failure
                    });
            });
        }

        // Global volume control
        const globalVolume = 0.5; // Fixed 50% volume

        // KPI tile sound counter
        let kpiSoundCounter = 1;

        // Show loading overlay when hero cards are clicked
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            const heroCards = document.querySelectorAll('.hero-card');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const clearFilterBtn = document.querySelector('.clear-filter-btn');

            console.log('Found hero cards:', heroCards.length);
            console.log('Hero cards:', heroCards);

            // Load audio data
            loadAudioData();

            // Add click handler to hero cards with capture phase
            console.log('Adding click handlers to', heroCards.length, 'cards');
            heroCards.forEach(function(card, index) {
                console.log('Adding listener to card', index);
                card.addEventListener('click', async function(e) {
                    console.log('CLICK EVENT FIRED!');
                    e.preventDefault();
                    e.stopPropagation();

                    // Get hero_id from the URL
                    const href = card.getAttribute('href');
                    console.log('Card clicked, href:', href);

                    const urlParams = new URLSearchParams(href.split('?')[1]);
                    const heroId = parseInt(urlParams.get('hero_id'));
                    console.log('Extracted hero_id:', heroId);

                    // Show loading overlay immediately
                    loadingOverlay.classList.add('active');

                    // Play hero select sound and wait for it to finish before navigating
                    if (heroId) {
                        console.log('Waiting for hero audio to finish...');
                        await playHeroSelectSound(heroId);
                        console.log('Hero audio finished!');
                    }

                    console.log('Navigating now...');
                    // Navigate after audio finishes (or immediately if no audio)
                    window.location.href = href;
                }, true); // Use capture phase
            });

            // Add click handler to clear filter button
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Clear filter clicked');

                    // Show loading overlay
                    loadingOverlay.classList.add('active');

                    // Play UI sound and wait for it to finish
                    console.log('Playing UI sound for clear filter...');
                    await playDataFetchedSound();

                    console.log('Navigating to clear filter...');
                    // Navigate after sound finishes
                    window.location.href = clearFilterBtn.getAttribute('href');
                });
            }

            // Add click handler to "Analyze Another Player" button
            const backButton = document.querySelector('.back-button');
            if (backButton) {
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Analyze Another Player clicked');

                    // Play UI sound (non-blocking)
                    console.log('Playing UI sound for back button...');
                    playDataFetchedSound();

                    console.log('Navigating to index...');
                    // Navigate immediately while sound plays
                    window.location.href = backButton.getAttribute('href');
                });
            }

            // Add click handler to Deadlock logo (same sound as avatar)
            const deadlockLogo = document.querySelector('.dashboard-logo');
            if (deadlockLogo) {
                deadlockLogo.style.cursor = 'pointer';
                deadlockLogo.addEventListener('click', function() {
                    console.log('Deadlock logo clicked');
                    const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_friends_list_send_invite_02.mp3';
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => console.log('Logo sound started playing!'))
                        .catch(err => console.error('Failed to play logo sound:', err));
                });
            }

            // Add click handler to player avatar
            const playerAvatar = document.querySelector('.player-avatar');
            if (playerAvatar) {
                playerAvatar.style.cursor = 'pointer';
                playerAvatar.addEventListener('click', function() {
                    console.log('Player avatar clicked');
                    const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_friends_list_send_invite_02.mp3';
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => console.log('Avatar sound started playing!'))
                        .catch(err => console.error('Failed to play avatar sound:', err));
                });
            }

            // Add click handlers to KPI tiles
            const kpiTiles = document.querySelectorAll('.summary-card');
            kpiTiles.forEach(function(tile) {
                tile.style.cursor = 'pointer';
                tile.addEventListener('click', function() {
                    console.log('KPI tile clicked, counter:', kpiSoundCounter);

                    // Wait for audio data to load if not ready
                    if (!soundsData || !soundsData.player || !soundsData.player.footsteps) {
                        console.log('Audio data not ready yet');
                        return;
                    }

                    // Navigate to player.footsteps.shared.surface_sweeteners.soft_impact
                    const footsteps = soundsData.player.footsteps;
                    if (!footsteps.shared || !footsteps.shared.surface_sweeteners || !footsteps.shared.surface_sweeteners.soft_impact) {
                        console.log('Footstep sounds not found in expected path');
                        return;
                    }

                    const softImpactSounds = footsteps.shared.surface_sweeteners.soft_impact;

                    // Find the dirt sound with current counter number (two-digit format)
                    const soundKey = `dirt_${String(kpiSoundCounter).padStart(2, '0')}`;
                    const soundUrl = softImpactSounds[soundKey];

                    if (!soundUrl) {
                        console.log('Sound not found:', soundKey);
                        // Try to find any dirt sounds to debug
                        const dirtSounds = Object.keys(softImpactSounds).filter(k => k.startsWith('dirt_'));
                        console.log('Available dirt sounds:', dirtSounds);
                        return;
                    }

                    console.log('Playing sound:', soundKey);
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => {
                            console.log('KPI sound started playing!');
                            // Increment counter
                            kpiSoundCounter++;
                            if (kpiSoundCounter > 14) {
                                kpiSoundCounter = 1; // Reset to 1
                            }
                        })
                        .catch(err => console.error('Failed to play KPI sound:', err));
                });
            });

            // Hide loading overlay if back button is used
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    loadingOverlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
