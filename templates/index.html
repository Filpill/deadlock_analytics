<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deadlock Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<body>
    <div class="banner-container">
        <img src="{{ url_for('static', filename='img/custom-cityscape-banner-filip.jpg') }}" alt="Deadlock Cityscape" class="cityscape-banner">
    </div>
    <div class="page-wrapper">
        <div class="container">
            <h1>Search Player</h1>
            <p class="subtitle">Advanced player statistics and performance analysis</p>
            <div class="steam-badge">Powered by Deadlock API</div>

            {% if error %}
            <div class="error">
                {{ error }}
            </div>
            {% endif %}

            <form method="POST" action="/analyze" id="analyzeForm">
                <div class="form-group">
                    <label for="player_id">Player ID (SteamID3 Format)</label>
                    <input type="text"
                           id="player_id"
                           name="player_id"
                           placeholder="e.g., 199540209"
                           required
                           autocomplete="off">
                </div>

                <button type="submit">Analyze Player Stats</button>
            </form>

            <div class="info-box">
            <h3>How to find your Player ID</h3>
            <p>Your Player ID is in SteamID3 format. You can find it by:</p>
            <ul>
                <li>Checking your Steam profile URL</li>
                <li>Using a SteamID converter tool</li>
            </ul>
            <p style="margin-top: 15px;"><strong>Example:</strong> <code>199540209</code></p>
            </div>
        </div>

        {% if rank_distribution %}
        <div class="rank-distribution-container">
            <h3>Player Rank Distribution (Last 30 Days)</h3>
            <div id="rankDistributionChart"></div>
        </div>
        {% endif %}
    </div>

    <!-- Leaderboard Section -->
    {% if leaderboard %}
    <div class="leaderboard-section">
        <h2 class="leaderboard-title">Global Top 40 Players</h2>
        <div class="leaderboard-columns">
            {% for col in range(4) %}
            <div class="leaderboard-column">
                {% for i in range(10) %}
                {% set idx = col * 10 + i %}
                {% if idx < leaderboard|length %}
                {% set player = leaderboard[idx] %}
                <div class="leaderboard-player" data-account-id="{{ player.account_id }}">
                    <div class="player-rank">#{{ player.rank }}</div>
                    <img src="{{ player.avatar_url }}"
                         alt="Avatar"
                         class="player-avatar"
                         onerror="this.src='https://avatars.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg'">
                    <div class="player-info">
                        <div class="player-username">{{ player.username }}</div>
                        <div class="player-account-id">{{ player.account_id }}</div>
                    </div>
                    {% if player.performance_rank %}
                    <div class="player-rank-text">{{ player.performance_rank }}</div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing Player Data</div>
        <div class="loading-subtext">Fetching match history, statistics, and performance metrics...</div>
    </div>

    <!-- Plotly for rank distribution chart -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script>
        // Render rank distribution chart if data is available
        {% if rank_distribution %}
        var rankDistChart = {{ rank_distribution | safe }};

        // Apply Steam theme colors to the chart
        rankDistChart.layout.paper_bgcolor = 'rgba(0, 0, 0, 0)';
        rankDistChart.layout.plot_bgcolor = 'rgba(22, 32, 45, 0.4)';
        rankDistChart.layout.font = { color: '#c7d5e0', family: 'Motiva Sans, Arial' };
        rankDistChart.layout.xaxis.gridcolor = '#3d4e5c';
        rankDistChart.layout.yaxis.gridcolor = '#3d4e5c';

        Plotly.newPlot('rankDistributionChart', rankDistChart.data, rankDistChart.layout, {responsive: true});
        {% endif %}
    </script>

    <script>
        // Play UI sound when data is fetched
        function playDataFetchedSound() {
            return new Promise((resolve, reject) => {
                const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_hud_acquire_ap_02.mp3';
                const audio = new Audio(soundUrl);
                audio.volume = 0.5;

                audio.addEventListener('ended', () => {
                    console.log('UI sound finished playing!');
                    resolve();
                });

                audio.addEventListener('error', (err) => {
                    console.error('UI sound failed to load:', err);
                    resolve(); // Continue even if sound fails
                });

                audio.play()
                    .then(() => console.log('UI sound started playing successfully!'))
                    .catch(err => {
                        console.error('UI sound play failed:', err);
                        resolve(); // Continue even if sound fails
                    });
            });
        }

        document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission

            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('active');

            // Play UI sound and wait for it to finish
            await playDataFetchedSound();

            // Submit the form manually after sound finishes
            e.target.submit();
        });

        // Add click handlers to leaderboard players
        document.querySelectorAll('.leaderboard-player').forEach(function(playerDiv) {
            playerDiv.addEventListener('click', async function() {
                const accountId = this.getAttribute('data-account-id');
                if (accountId && accountId !== 'N/A') {
                    // Show loading overlay
                    document.getElementById('loadingOverlay').classList.add('active');

                    // Play UI sound
                    await playDataFetchedSound();

                    // Navigate to analyze page
                    window.location.href = `/analyze?player_id=${accountId}`;
                }
            });
        });
    </script>
</body>
</html>
