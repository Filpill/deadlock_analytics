<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Analytics - {{ player_id }}</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Motiva Sans', 'Arial', sans-serif;
            background-image: url("{{ url_for('static', filename='img/catalog_tooltip_bg_modifies_vitality.webp') }}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: #c7d5e0;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(22, 32, 45, 0.85);
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(to bottom, #2a475e 0%, #1b2838 100%);
            border: 1px solid #3d4e5c;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            padding: 50px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .player-profile {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .player-avatar {
            width: 120px;
            height: 120px;
            border-radius: 4px;
            border: 2px solid #66c0f4;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .player-avatar:hover {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.4));
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .player-username {
            color: #c7d5e0;
            font-size: 1.95em;
            font-weight: 400;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-start;
        }

        .rank-badge {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-top: -8px;
            cursor: pointer;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .rank-badge:hover {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.4));
        }

        .player-steam-id {
            color: #8f98a0;
            font-size: 0.95em;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .player-steam-id span {
            color: #66c0f4;
            font-weight: 400;
        }

        .dashboard-logo {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            height: 120px;
            width: auto;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
            transition: filter 0.3s ease;
        }

        .dashboard-logo:hover {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.4));
        }

        .back-button-container {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }


        .back-button {
            display: inline-block;
            padding: 12px 35px;
            background: linear-gradient(to right, #47bfff 5%, #1a44c2 60%);
            background-position: 25%;
            background-size: 330% 100%;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-weight: 400;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.2);
        }

        .back-button:hover {
            background-position: 0%;
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.4);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .kda-values {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .kda-values .value {
            font-size: 2.2em;
        }

        .kda-values .separator {
            color: #5c7a8a;
            font-size: 2em;
            font-weight: 300;
        }

        .summary-card {
            background: linear-gradient(to bottom, rgba(42, 71, 94, 0.8) 0%, rgba(27, 40, 56, 0.8) 100%);
            border: 1px solid #3d4e5c;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .summary-card:hover {
            border-color: #66c0f4;
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.2);
            transform: translateY(-2px);
        }

        .summary-card h3 {
            color: #8f98a0;
            font-size: 0.75em;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .summary-card .value {
            color: #c7d5e0;
            font-size: 2.2em;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .summary-card.win-rate .value {
            color: #66c0f4;
            text-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .chart-container {
            background: linear-gradient(to bottom, rgba(42, 71, 94, 0.6) 0%, rgba(27, 40, 56, 0.6) 100%);
            border: 1px solid #3d4e5c;
            border-radius: 4px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.2s ease;
        }

        .chart-container:hover {
            border-color: #4a5f73;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }

        .map-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .map-chart-container #chart4 {
            max-width: 600px;
            margin: 0 auto;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-row .chart-container {
            margin-bottom: 0;
        }

        .chart-title {
            color: #66c0f4;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .no-data {
            text-align: center;
            color: #5c7a8a;
            padding: 60px;
            font-style: italic;
            font-size: 1.1em;
        }

        @media (max-width: 1400px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }

            .player-profile {
                display: none;
            }

            .dashboard-logo {
                display: none;
            }

            .back-button-container {
                display: none;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Update Plotly chart styling */
        .js-plotly-plot .plotly .modebar {
            background: rgba(27, 40, 56, 0.9) !important;
            border: 1px solid #3d4e5c !important;
        }

        .js-plotly-plot .plotly .modebar-btn path {
            fill: #66c0f4 !important;
        }

        .js-plotly-plot .plotly .modebar-btn:hover path {
            fill: #ffffff !important;
        }

        .top-heroes-container {
            background: linear-gradient(to bottom, #2a475e 0%, #1b2838 100%);
            border: 1px solid #3d4e5c;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            padding: 30px;
            margin: 30px 0;
        }

        .top-heroes-section {
            margin: 0;
        }

        .top-heroes-title {
            color: #66c0f4;
            font-size: 1.8em;
            font-weight: 400;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .top-heroes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-card {
            background: linear-gradient(to bottom, #2a475e 0%, #1b2838 100%);
            border: 1px solid #3d4e5c;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .hero-card:hover {
            transform: translateY(-5px);
            border-color: #66c0f4;
        }

        .hero-icon {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 2px solid #3d4e5c;
        }

        .hero-name {
            color: #c7d5e0;
            font-size: 1.2em;
            font-weight: 400;
            margin-bottom: 10px;
        }

        .hero-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .hero-stat {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hero-stat-label {
            color: #8f98a0;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hero-stat-value {
            color: #66c0f4;
            font-size: 1.1em;
            font-weight: 400;
        }

        /* Make hero cards clickable */
        .hero-card {
            text-decoration: none;
            color: inherit;
            display: block;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Highlight selected hero card */
        .hero-card-selected {
            border: 3px solid #66c0f4 !important;
            box-shadow: 0 0 25px rgba(102, 192, 244, 0.8);
            transform: translateY(-8px);
        }

        /* Dim unselected cards when filter active */
        body:has(.hero-card-selected) .hero-card:not(.hero-card-selected) {
            opacity: 0.5;
        }

        .hero-card:not(.hero-card-selected):hover {
            opacity: 1;
        }

        /* Filter badge */
        .filter-badge {
            display: inline-block;
            background: linear-gradient(to right, rgba(92, 200, 92, 0.2), rgba(92, 200, 92, 0.1));
            border: 1px solid rgba(92, 200, 92, 0.5);
            padding: 6px 14px;
            border-radius: 3px;
            font-size: 0.65em;
            color: #5cc85c;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 15px;
            vertical-align: middle;
        }

        /* Clear filter button */
        .clear-filter-btn {
            display: inline-block;
            padding: 6px 20px;
            background: transparent;
            border: 2px solid #d94040;
            color: #d94040;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.55em;
            font-weight: 400;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .clear-filter-btn:hover {
            background: #d94040;
            color: white;
            box-shadow: 0 0 15px rgba(217, 64, 64, 0.4);
        }

        /* Filter subtitle for items table */
        .filter-subtitle {
            color: #8f98a0;
            font-size: 12px;
            margin: 10px 0 0 0;
            padding: 0;
        }

        .filter-hero-name {
            color: #66c0f4;
            font-weight: 500;
        }

        /* Items table styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .items-table thead {
            background: rgba(42, 71, 94, 0.4);
            border-bottom: 2px solid #66c0f4;
        }

        .items-table th {
            color: #66c0f4;
            padding: 12px 15px;
            text-align: left;
            font-weight: 400;
            font-size: 0.95em;
            letter-spacing: 0.5px;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #3d4e5c;
            transition: background-color 0.2s ease;
        }

        .items-table tbody tr:hover {
            background: rgba(102, 192, 244, 0.1);
        }

        .items-table td {
            padding: 12px 15px;
            color: #c7d5e0;
        }

        .item-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid #3d4e5c;
        }

        .item-matches {
            color: #8f98a0;
            font-weight: 500;
        }

        .item-winrate {
            color: #66c0f4;
            font-weight: 500;
        }

        /* Recent Matches Table */
        .matches-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .pagination-controls-bottom {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding-right: 10px;
        }

        .pagination-btn {
            background: linear-gradient(to right, #47bfff 5%, #1a44c2 60%);
            background-position: 25%;
            background-size: 330% 100%;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Motiva Sans', 'Arial', sans-serif;
        }

        .pagination-btn:hover:not(:disabled) {
            background-position: 0%;
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
        }

        .pagination-btn:disabled {
            background: #3d4e5c;
            color: #8f98a0;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .page-info {
            color: #c7d5e0;
            font-size: 0.95em;
            font-weight: 400;
            min-width: 100px;
            text-align: center;
        }

        .recent-matches-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0px;
        }

        .recent-matches-table thead {
            background: rgba(42, 71, 94, 0.4);
            border-bottom: 2px solid #66c0f4;
        }

        .recent-matches-table th {
            color: #66c0f4;
            padding: 12px 10px;
            text-align: center;
            font-weight: 400;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        .recent-matches-table th:nth-child(3) {
            text-align: left;
            padding-left: 15px;
        }

        .recent-matches-table tbody tr {
            border-bottom: 1px solid #3d4e5c;
            transition: background-color 0.2s ease;
        }

        .recent-matches-table tbody tr.match-win {
            border-left: 3px solid #5cc85c;
        }

        .recent-matches-table tbody tr.match-loss {
            border-left: 3px solid #d94040;
        }

        .recent-matches-table tbody tr:hover {
            background: rgba(102, 192, 244, 0.1);
        }

        .recent-matches-table td {
            padding: 12px 10px;
            color: #c7d5e0;
            text-align: center;
            font-size: 0.9em;
        }

        .recent-matches-table .stat-matchid {
            color: #8f98a0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .recent-matches-table .stat-date {
            color: #c7d5e0;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .recent-matches-table .hero-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
            padding-left: 15px;
        }

        .recent-matches-table .hero-icon-sm {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid #3d4e5c;
            flex-shrink: 0;
        }

        .recent-matches-table .match-result {
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .recent-matches-table .result-win {
            color: #5cc85c;
        }

        .recent-matches-table .result-loss {
            color: #d94040;
        }

        .recent-matches-table .stat-kills {
            color: #5cc85c;
            font-weight: 500;
        }

        .recent-matches-table .stat-deaths {
            color: #d94040;
            font-weight: 500;
        }

        .recent-matches-table .stat-assists {
            color: #66c0f4;
            font-weight: 500;
        }

        .recent-matches-table .stat-networth,
        .recent-matches-table .stat-lasthits,
        .recent-matches-table .stat-denies {
            color: #8f98a0;
        }

        .recent-matches-table .stat-duration {
            color: #c7d5e0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        /* Responsive: stack on smaller screens */
        @media (max-width: 900px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        /* Flex layout for title with badges */
        .top-heroes-title {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 17, 23, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #3d4e5c;
            border-top: 4px solid #66c0f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #66c0f4;
            font-size: 18px;
            margin-top: 20px;
            font-weight: 300;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Applying filter...</div>
    </div>
    <div class="container">
        <div class="header">
            {% if steam_data and steam_data.avatar_full %}
            <div class="player-profile">
                <img src="{{ steam_data.avatar_full }}" alt="Player Avatar" class="player-avatar">
                <div class="player-info">
                    <div class="player-username">
                        {{ steam_data.username }}
                        {% if steam_data.rank_badge %}
                        <img src="{{ steam_data.rank_badge }}" alt="{{ steam_data.rank_name }}" class="rank-badge" title="{{ steam_data.rank_name }}{% if steam_data.rank_division_tier %} {{ steam_data.rank_division_tier }}{% endif %}">
                        {% endif %}
                    </div>
                    <p class="player-steam-id">Steam ID: <span>{{ player_id }}</span></p>
                </div>
            </div>
            {% endif %}
            <img src="/static/img/deadlock-logo-no-title-flat.png" alt="Deadlock" class="dashboard-logo">
            <div class="back-button-container">
                <a href="/" class="back-button">Analyze Another Player</a>
            </div>
        </div>

        {% if summary %}
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Matches</h3>
                <div class="value">{{ summary.total_matches }}</div>
            </div>
            <div class="summary-card">
                <h3>Wins</h3>
                <div class="value" style="color: #5cc85c;">{{ summary.wins }}</div>
            </div>
            <div class="summary-card">
                <h3>Losses</h3>
                <div class="value" style="color: #d94040;">{{ summary.losses }}</div>
            </div>
            <div class="summary-card win-rate">
                <h3>Win Rate</h3>
                <div class="value">{{ summary.win_rate }}</div>
            </div>
            {% if summary.avg_kills and summary.avg_deaths and summary.avg_assists %}
            <div class="summary-card">
                <h3>Avg K / D / A</h3>
                <div class="kda-values">
                    <span class="value" style="color: #5cc85c;">{{ summary.avg_kills }}</span>
                    <span class="separator">/</span>
                    <span class="value" style="color: #d94040;">{{ summary.avg_deaths }}</span>
                    <span class="separator">/</span>
                    <span class="value" style="color: #66c0f4;">{{ summary.avg_assists }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if top_heroes %}
        <div class="top-heroes-container">
            <div class="top-heroes-section">
                <h2 class="top-heroes-title">
                    <span>Top 5 Heroes by Games Played</span>
                    {% if filtered_hero_name %}
                    <span class="filter-badge">Viewing: {{ filtered_hero_name }}</span>
                    <a href="/analyze?player_id={{ player_id }}" class="clear-filter-btn">Clear Filter</a>
                    {% endif %}
                </h2>
                <div class="top-heroes-grid">
                    {% for hero in top_heroes %}
                    <a href="/analyze?player_id={{ player_id }}&hero_id={{ hero.hero_id }}"
                       class="hero-card {% if hero_id == hero.hero_id %}hero-card-selected{% endif %}">
                        {% if hero.icon_url %}
                        <img src="{{ hero.icon_url }}" alt="{{ hero.name }}" class="hero-icon">
                        {% endif %}
                        <div class="hero-name">{{ hero.name }}</div>
                        <div class="hero-stats">
                            <div class="hero-stat">
                                <div class="hero-stat-label">Matches</div>
                                <div class="hero-stat-value">{{ hero.matches }}</div>
                            </div>
                            <div class="hero-stat">
                                <div class="hero-stat-label">Win Rate</div>
                                <div class="hero-stat-value">{{ hero.win_rate }}</div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Matches Table -->
        {% if recent_matches %}
        <div class="chart-container">
            <div class="matches-header">
                <h3 class="chart-title">Match History</h3>
                {% if filtered_hero_name %}
                <p class="filter-subtitle">Filter Applied: <span class="filter-hero-name">{{ filtered_hero_name }}</span></p>
                {% endif %}
            </div>
            <table class="recent-matches-table">
                <thead>
                    <tr>
                        <th>Match ID</th>
                        <th>Date</th>
                        <th>Hero</th>
                        <th>Result</th>
                        <th>K</th>
                        <th>D</th>
                        <th>A</th>
                        <th>Net Worth</th>
                        <th>Last Hits</th>
                        <th>Denies</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="matchesTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
            <div class="pagination-controls-bottom">
                <button id="prevPage" class="pagination-btn" disabled>&laquo; Previous</button>
                <span id="pageInfo" class="page-info">Page 1 of 1</span>
                <button id="nextPage" class="pagination-btn" disabled>Next &raquo;</button>
            </div>
        </div>

        <script>
            // Match history pagination
            const allMatches = {{ recent_matches | tojson }};
            const matchesPerPage = 5;
            let currentPage = 1;
            const totalPages = Math.ceil(allMatches.length / matchesPerPage);
            let tableSoundCounter = 1; // Counter for sequential tile sounds

            function renderMatches(page) {
                const start = (page - 1) * matchesPerPage;
                const end = start + matchesPerPage;
                const matchesToShow = allMatches.slice(start, end);

                const tbody = document.getElementById('matchesTableBody');
                tbody.innerHTML = '';

                matchesToShow.forEach(match => {
                    const row = document.createElement('tr');
                    row.className = match.result === 'Win' ? 'match-win' : 'match-loss';

                    // Format date from Unix timestamp
                    const date = new Date(match.start_time * 1000);
                    const dateStr = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    row.innerHTML = `
                        <td class="stat-matchid">${match.match_id}</td>
                        <td class="stat-date">${dateStr}</td>
                        <td class="hero-name-cell">
                            ${match.hero_icon ? `<img src="${match.hero_icon}" alt="${match.hero_name}" class="hero-icon-sm">` : ''}
                            <span>${match.hero_name}</span>
                        </td>
                        <td class="match-result ${match.result === 'Win' ? 'result-win' : 'result-loss'}">${match.result}</td>
                        <td class="stat-kills">${match.kills}</td>
                        <td class="stat-deaths">${match.deaths}</td>
                        <td class="stat-assists">${match.assists}</td>
                        <td class="stat-networth">${match.net_worth.toLocaleString()}</td>
                        <td class="stat-lasthits">${match.last_hits}</td>
                        <td class="stat-denies">${match.denies}</td>
                        <td class="stat-duration">${Math.floor(match.duration_s / 60)}:${String(match.duration_s % 60).padStart(2, '0')}</td>
                    `;

                    // Add click handler to play tile sound
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function() {
                        // Wait for audio data to load if not ready
                        if (!soundsData || !soundsData.player || !soundsData.player.footsteps) {
                            console.log('Audio data not ready yet');
                            return;
                        }

                        // Navigate to player.footsteps.shared.surface_sweeteners.soft_impact
                        const footsteps = soundsData.player.footsteps;
                        if (!footsteps.shared || !footsteps.shared.surface_sweeteners || !footsteps.shared.surface_sweeteners.soft_impact) {
                            console.log('Footstep sounds not found in expected path');
                            return;
                        }

                        const softImpactSounds = footsteps.shared.surface_sweeteners.soft_impact;

                        // Find the tile sound with current counter number (two-digit format)
                        const soundKey = `tile_${String(tableSoundCounter).padStart(2, '0')}`;
                        const soundUrl = softImpactSounds[soundKey];

                        if (!soundUrl) {
                            console.log('Tile sound not found:', soundKey);
                            return;
                        }

                        console.log('Playing tile sound:', soundKey);
                        const audio = new Audio(soundUrl);
                        audio.volume = 0.5;
                        audio.play()
                            .then(() => {
                                console.log('Table row sound started playing!');
                                // Increment counter
                                tableSoundCounter++;
                                if (tableSoundCounter > 14) {
                                    tableSoundCounter = 1; // Reset to 1
                                }
                            })
                            .catch(err => console.error('Failed to play table row sound:', err));
                    });

                    tbody.appendChild(row);
                });

                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;

                // Update button states
                document.getElementById('prevPage').disabled = page === 1;
                document.getElementById('nextPage').disabled = page === totalPages;
            }

            function playPaginationSound() {
                const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_shop_click_vitality.mp3';
                const audio = new Audio(soundUrl);
                audio.volume = 0.5;
                audio.play().catch(err => console.error('Pagination sound failed to play:', err));
            }

            function changePage(delta) {
                playPaginationSound();
                currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
                renderMatches(currentPage);
            }

            // Initialize pagination
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));

            // Render first page
            renderMatches(1);
        </script>
        {% endif %}

        {% if charts %}
            {% if charts.win_loss_timeline %}
            <div class="chart-container">
                <div id="chart1"></div>
            </div>
            {% endif %}

            {% if charts.performance_curve %}
            <div class="chart-container">
                <div id="chart3"></div>
            </div>
            {% endif %}

            {% if charts.percentile_dist %}
            <div class="chart-container">
                <div id="chart4_5"></div>
            </div>
            {% endif %}

            {% if charts.kda_trend %}
            <div class="chart-container">
                <div id="chart6"></div>
            </div>
            {% endif %}

            {% if charts.kd_stats or top_items %}
            <div class="chart-row">
                <!-- Left column: Kill/Death Map -->
                {% if charts.kd_stats %}
                <div class="chart-container">
                    <div id="chart4"></div>
                </div>
                {% endif %}

                <!-- Right column: Top 10 Items Table -->
                {% if top_items %}
                <div class="chart-container">
                    <h3 class="chart-title">Top 10 Items Played</h3>
                    {% if filtered_hero_name %}
                    <p class="filter-subtitle">Filter Applied: <span class="filter-hero-name">{{ filtered_hero_name }}</span></p>
                    {% endif %}
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Matches</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in top_items %}
                            <tr>
                                <td class="item-name-cell">
                                    {% if item.icon_url %}
                                    <img src="{{ item.icon_url }}" alt="{{ item.name }}" class="item-icon">
                                    {% endif %}
                                    <span>{{ item.name }}</span>
                                </td>
                                <td class="item-matches">{{ item.matches }}</td>
                                <td class="item-winrate">{{ item.win_rate }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if charts.hero_heatmap %}
            <div class="chart-container">
                <div id="chart8"></div>
            </div>
            {% endif %}

            {% if charts.mmr_history %}
            <div class="chart-container">
                <div id="chart7"></div>
            </div>
            {% endif %}
        {% else %}
            <div class="chart-container">
                <p class="no-data">No chart data available</p>
            </div>
        {% endif %}
    </div>

    <script>
        // Deep merge function to preserve existing properties
        function deepMerge(target, source) {
            for (let key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = target[key] || {};
                    deepMerge(target[key], source[key]);
                } else if (source[key] !== undefined) {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // Apply Steam theme to a chart layout
        function applySteamTheme(layout, darkBg) {
            // Preserve existing title text, only update styling
            if (layout.title) {
                if (typeof layout.title === 'string') {
                    layout.title = {
                        text: layout.title,
                        font: { color: '#66c0f4', size: 22 }
                    };
                } else if (layout.title.text) {
                    layout.title.font = { color: '#66c0f4', size: 22 };
                }
            }

            // Apply base styling
            layout.paper_bgcolor = 'rgba(27, 40, 56, 0)';
            layout.plot_bgcolor = darkBg ? 'rgba(22, 32, 45, 0.8)' : 'rgba(22, 32, 45, 0.4)';

            layout.font = layout.font || {};
            layout.font.family = 'Motiva Sans, Arial, sans-serif';
            layout.font.color = '#c7d5e0';
            layout.font.size = 12;

            // Apply axis styling (preserve existing axis properties)
            ['xaxis', 'yaxis', 'yaxis2'].forEach(function(axis) {
                if (layout[axis]) {
                    layout[axis].gridcolor = '#3d4e5c';
                    layout[axis].linecolor = '#3d4e5c';
                    layout[axis].zerolinecolor = '#3d4e5c';
                    layout[axis].tickfont = layout[axis].tickfont || {};
                    layout[axis].tickfont.color = '#8f98a0';

                    // Preserve title styling
                    if (layout[axis].title) {
                        if (typeof layout[axis].title === 'string') {
                            layout[axis].title = {
                                text: layout[axis].title,
                                font: { color: '#c7d5e0' }
                            };
                        } else if (layout[axis].title.text) {
                            layout[axis].title.font = layout[axis].title.font || {};
                            layout[axis].title.font.color = '#c7d5e0';
                        }
                    }
                }
            });

            // Apply legend styling
            if (layout.legend) {
                layout.legend.bgcolor = 'rgba(27, 40, 56, 0.9)';
                layout.legend.bordercolor = '#3d4e5c';
                layout.legend.borderwidth = 1;
                layout.legend.font = layout.legend.font || {};
                layout.legend.font.color = '#c7d5e0';
            }

            return layout;
        }

        {% if charts %}
            {% if charts.win_loss_timeline %}
            var chart1 = {{ charts.win_loss_timeline | safe }};
            applySteamTheme(chart1.layout, false);
            Plotly.newPlot('chart1', chart1.data, chart1.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.performance_curve %}
            var chart3 = {{ charts.performance_curve | safe }};
            applySteamTheme(chart3.layout, false);
            Plotly.newPlot('chart3', chart3.data, chart3.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.kd_stats %}
            var chart4 = {{ charts.kd_stats | safe }};
            applySteamTheme(chart4.layout, true);  // Darker background for map
            Plotly.newPlot('chart4', chart4.data, chart4.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.percentile_dist %}
            var chart4_5 = {{ charts.percentile_dist | safe }};
            applySteamTheme(chart4_5.layout, false);
            Plotly.newPlot('chart4_5', chart4_5.data, chart4_5.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.kda_trend %}
            var chart6 = {{ charts.kda_trend | safe }};
            applySteamTheme(chart6.layout, false);
            Plotly.newPlot('chart6', chart6.data, chart6.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.mmr_history %}
            var chart7 = {{ charts.mmr_history | safe }};
            applySteamTheme(chart7.layout, false);
            Plotly.newPlot('chart7', chart7.data, chart7.layout, {displayModeBar: true, displaylogo: false});
            {% endif %}

            {% if charts.hero_heatmap %}
            var chart8 = {{ charts.hero_heatmap | safe }};
            applySteamTheme(chart8.layout, false);
            Plotly.newPlot('chart8', chart8.data, chart8.layout, {displayModeBar: true, displaylogo: false});

            // Store original full dataset for filtering
            var chart8OriginalData = {
                z: JSON.parse(JSON.stringify(chart8.data[0].z)),
                text: JSON.parse(JSON.stringify(chart8.data[0].text)),
                y: JSON.parse(JSON.stringify(chart8.data[0].y)),
                customdata: JSON.parse(JSON.stringify(chart8.data[0].customdata)),
                images: JSON.parse(JSON.stringify(chart8.layout.images || [])),
                annotations: JSON.parse(JSON.stringify(chart8.layout.annotations || []))
            };

            // The last annotation is the filter label, separate it from hero annotations
            var filterLabelAnnotation = chart8OriginalData.annotations[chart8OriginalData.annotations.length - 1];
            var heroAnnotations = chart8OriginalData.annotations.slice(0, -1);
            chart8OriginalData.heroAnnotations = heroAnnotations;

            // Add button click handler for filtering by minimum matches
            document.getElementById('chart8').on('plotly_buttonclicked', function(data) {
                var threshold = data.button.args[0];
                console.log('Filtering heroes with >= ' + threshold + ' matches');

                // Filter data based on threshold
                var filtered = [];
                for (var i = 0; i < chart8OriginalData.y.length; i++) {
                    var matches = chart8OriginalData.customdata[i][0];
                    if (matches >= threshold) {
                        filtered.push({
                            hero: chart8OriginalData.y[i],
                            zRow: chart8OriginalData.z[i],
                            textRow: chart8OriginalData.text[i],
                            customdataRow: chart8OriginalData.customdata[i],
                            image: chart8OriginalData.images[i] || null,
                            annotation: chart8OriginalData.heroAnnotations[i] || null,
                            matches: matches
                        });
                    }
                }

                // Extract filtered data
                var newZ = [];
                var newText = [];
                var newY = [];
                var newCustomdata = [];
                var newImages = [];
                var newAnnotations = [];

                for (var i = 0; i < filtered.length; i++) {
                    newZ.push(filtered[i].zRow);
                    newText.push(filtered[i].textRow);
                    newY.push(filtered[i].hero);
                    newCustomdata.push(filtered[i].customdataRow);
                    if (filtered[i].image) {
                        var updatedImage = Object.assign({}, filtered[i].image);
                        updatedImage.y = i;
                        newImages.push(updatedImage);
                    }
                    if (filtered[i].annotation) {
                        var updatedAnnotation = Object.assign({}, filtered[i].annotation);
                        updatedAnnotation.y = i;
                        newAnnotations.push(updatedAnnotation);
                    }
                }

                // Add filter label annotation at the end
                newAnnotations.push(filterLabelAnnotation);

                // Update chart
                Plotly.update('chart8', {
                    z: [newZ],
                    text: [newText],
                    y: [newY],
                    customdata: newCustomdata
                }, {
                    images: newImages,
                    annotations: newAnnotations,
                    'yaxis.tickvals': Array.from({length: newY.length}, function(_, i) { return i; }),
                    'yaxis.ticktext': Array(newY.length).fill(''),
                    height: Math.max(800, newY.length * 40),
                    'title.text': 'Hero Performance Heatmap (Min ' + threshold + ' matches)'
                });
            });

            // Add click handler for sorting by metric (click anywhere in a column to sort by that metric)
            document.getElementById('chart8').on('plotly_click', function(data) {
                var clickedPoint = data.points[0];
                var metricIndex = clickedPoint.pointIndex[1];  // Column index (x position)
                var metricName = chart8.data[0].x[metricIndex];

                console.log('Clicked metric:', metricName, 'at index:', metricIndex);

                // Get current data from the actual chart (might be filtered)
                Plotly.Fx.hover('chart8', []);  // Clear hover
                var currentData = document.getElementById('chart8').data[0];
                var currentLayout = document.getElementById('chart8').layout;

                var currentZ = currentData.z;
                var currentText = currentData.text;
                var currentY = currentData.y;
                var currentCustomdata = currentData.customdata || [];
                var currentImages = currentLayout.images || [];
                var currentAnnotations = currentLayout.annotations || [];

                // Separate hero annotations from label annotation (last one)
                var currentHeroAnnotations = currentAnnotations.slice(0, -1);
                var currentLabelAnnotation = currentAnnotations[currentAnnotations.length - 1];

                // Create array with all row data for sorting
                var sortData = [];
                for (var i = 0; i < currentY.length; i++) {
                    sortData.push({
                        hero: currentY[i],
                        value: currentZ[i][metricIndex],
                        zRow: currentZ[i],
                        textRow: currentText[i],
                        customdataRow: currentCustomdata[i] || [0],
                        image: currentImages[i] || null,
                        annotation: currentHeroAnnotations[i] || null
                    });
                }

                // Sort by clicked metric (descending - highest first)
                sortData.sort(function(a, b) {
                    return b.value - a.value;
                });

                // Extract sorted data
                var newZ = [];
                var newText = [];
                var newY = [];
                var newCustomdata = [];
                var newImages = [];
                var newAnnotations = [];

                for (var i = 0; i < sortData.length; i++) {
                    newZ.push(sortData[i].zRow);
                    newText.push(sortData[i].textRow);
                    newY.push(sortData[i].hero);
                    newCustomdata.push(sortData[i].customdataRow);
                    if (sortData[i].image) {
                        var updatedImage = Object.assign({}, sortData[i].image);
                        updatedImage.y = i;
                        newImages.push(updatedImage);
                    }
                    if (sortData[i].annotation) {
                        var updatedAnnotation = Object.assign({}, sortData[i].annotation);
                        updatedAnnotation.y = i;
                        newAnnotations.push(updatedAnnotation);
                    }
                }

                // Add filter label annotation at the end
                newAnnotations.push(currentLabelAnnotation);

                // Update chart
                Plotly.update('chart8', {
                    z: [newZ],
                    text: [newText],
                    y: [newY],
                    customdata: newCustomdata
                }, {
                    images: newImages,
                    annotations: newAnnotations,
                    'yaxis.tickvals': Array.from({length: newY.length}, function(_, i) { return i; }),
                    'yaxis.ticktext': Array(newY.length).fill(''),
                    'title.text': 'Hero Performance Heatmap (Sorted by ' + metricName + ')'
                });
            });
            {% endif %}
        {% endif %}

        // Fetch sounds data and play voicelines when hero is selected
        let soundsData = null;
        let heroesData = null;

        // Fetch sounds and heroes data on page load
        async function loadAudioData() {
            try {
                console.log('Loading audio data...');
                const [soundsResponse, heroesResponse] = await Promise.all([
                    fetch('https://assets.deadlock-api.com/v1/sounds'),
                    fetch('https://assets.deadlock-api.com/v2/heroes')
                ]);
                soundsData = await soundsResponse.json();
                heroesData = await heroesResponse.json();
                console.log('Audio data loaded successfully');
                console.log('Heroes count:', heroesData.length);
                console.log('Sounds has vo key:', 'vo' in soundsData);
                if (soundsData.vo) {
                    console.log('VO hero classes:', Object.keys(soundsData.vo).slice(0, 5));
                }
            } catch (error) {
                console.error('Failed to load audio data:', error);
            }
        }

        // Play random select voiceline for a hero (returns a promise that resolves when audio finishes)
        function playHeroSelectSound(heroId) {
            return new Promise((resolve, reject) => {
            console.log('=== playHeroSelectSound called with heroId:', heroId);
                console.log('soundsData exists:', !!soundsData);
                console.log('heroesData exists:', !!heroesData);

                if (!soundsData || !heroesData) {
                    console.log('Audio data not loaded yet');
                    resolve(); // Resolve immediately if no audio data
                    return;
                }

                // Find hero by ID
                console.log('Searching for hero with id:', heroId);
                console.log('First 3 heroes:', heroesData.slice(0, 3).map(h => ({id: h.id, name: h.name})));
                const hero = heroesData.find(h => h.id === heroId);

                if (!hero) {
                    console.log('Hero not found for id:', heroId);
                    console.log('Available hero IDs:', heroesData.map(h => h.id).slice(0, 10));
                    resolve(); // Resolve immediately if hero not found
                    return;
                }

            let heroClassName = hero.class_name;
            console.log('Found hero:', hero.name, 'class_name:', heroClassName);

            // Remove "hero_" prefix if present (sounds API doesn't use the prefix)
            if (heroClassName.startsWith('hero_')) {
                heroClassName = heroClassName.substring(5); // Remove "hero_" prefix
                console.log('Stripped to:', heroClassName);
            }

            // Get voicelines for this hero
            const voSounds = soundsData.vo || {};
            console.log('VO sounds available:', Object.keys(voSounds).length);
            console.log('Looking for class_name:', heroClassName);
            const heroSounds = voSounds[heroClassName];

                if (!heroSounds) {
                    console.log('No sounds found for hero class:', heroClassName);
                    console.log('Available classes:', Object.keys(voSounds).slice(0, 10));
                    resolve(); // Resolve immediately if no sounds
                    return;
                }

                console.log('Hero sounds found:', Object.keys(heroSounds).length, 'total sounds');

                // Filter for select sounds
                const selectSounds = Object.entries(heroSounds).filter(([key, url]) =>
                    key.toLowerCase().includes('_select_')
                );

                console.log('Select sounds found:', selectSounds.length);

                if (selectSounds.length === 0) {
                    console.log('No select sounds found for:', heroClassName);
                    resolve(); // Resolve immediately if no select sounds
                    return;
                }

                // Pick random select sound
                const randomSound = selectSounds[Math.floor(Math.random() * selectSounds.length)];
                const [soundKey, soundUrl] = randomSound;

                console.log('Selected sound:', soundKey);
                console.log('Sound URL:', soundUrl);

                // Play the audio
                const audio = new Audio(soundUrl);
                audio.volume = globalVolume;

                // Resolve when audio ends
                audio.addEventListener('ended', () => {
                    console.log('Audio finished playing!');
                    resolve();
                });

                // Reject on error
                audio.addEventListener('error', (err) => {
                    console.error('Audio error:', err);
                    resolve(); // Still resolve to allow navigation
                });

                console.log('Attempting to play audio...');
                audio.play()
                    .then(() => console.log('Audio started playing successfully!'))
                    .catch(err => {
                        console.error('Audio play failed:', err);
                        resolve(); // Resolve even on play failure
                    });
            });
        }

        // Play UI sound when data is fetched (returns a promise that resolves when audio finishes)
        function playDataFetchedSound() {
            return new Promise((resolve, reject) => {
                const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_hud_acquire_ap_02.mp3';
                const audio = new Audio(soundUrl);
                audio.volume = globalVolume;

                // Resolve when audio ends
                audio.addEventListener('ended', () => {
                    console.log('UI sound finished playing!');
                    resolve();
                });

                // Reject on error
                audio.addEventListener('error', (err) => {
                    console.error('UI sound error:', err);
                    resolve(); // Still resolve to allow navigation
                });

                console.log('Playing UI sound from:', soundUrl);
                audio.play()
                    .then(() => console.log('UI sound started playing successfully!'))
                    .catch(err => {
                        console.error('Failed to play UI sound:', err);
                        resolve(); // Resolve even on play failure
                    });
            });
        }

        // Global volume control
        const globalVolume = 0.5; // Fixed 50% volume

        // KPI tile sound counter
        let kpiSoundCounter = 1;

        // Show loading overlay when hero cards are clicked
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            const heroCards = document.querySelectorAll('.hero-card');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const clearFilterBtn = document.querySelector('.clear-filter-btn');

            console.log('Found hero cards:', heroCards.length);
            console.log('Hero cards:', heroCards);

            // Load audio data
            loadAudioData();

            // Add click handler to hero cards with capture phase
            console.log('Adding click handlers to', heroCards.length, 'cards');
            heroCards.forEach(function(card, index) {
                console.log('Adding listener to card', index);
                card.addEventListener('click', async function(e) {
                    console.log('CLICK EVENT FIRED!');
                    e.preventDefault();
                    e.stopPropagation();

                    // Get hero_id from the URL
                    const href = card.getAttribute('href');
                    console.log('Card clicked, href:', href);

                    const urlParams = new URLSearchParams(href.split('?')[1]);
                    const heroId = parseInt(urlParams.get('hero_id'));
                    console.log('Extracted hero_id:', heroId);

                    // Show loading overlay immediately
                    loadingOverlay.classList.add('active');

                    // Play hero select sound and wait for it to finish before navigating
                    if (heroId) {
                        console.log('Waiting for hero audio to finish...');
                        await playHeroSelectSound(heroId);
                        console.log('Hero audio finished!');
                    }

                    console.log('Navigating now...');
                    // Navigate after audio finishes (or immediately if no audio)
                    window.location.href = href;
                }, true); // Use capture phase
            });

            // Add click handler to clear filter button
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Clear filter clicked');

                    // Show loading overlay
                    loadingOverlay.classList.add('active');

                    // Play UI sound and wait for it to finish
                    console.log('Playing UI sound for clear filter...');
                    await playDataFetchedSound();

                    console.log('Navigating to clear filter...');
                    // Navigate after sound finishes
                    window.location.href = clearFilterBtn.getAttribute('href');
                });
            }

            // Add click handler to "Analyze Another Player" button
            const backButton = document.querySelector('.back-button');
            if (backButton) {
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Analyze Another Player clicked');

                    // Play UI sound (non-blocking)
                    console.log('Playing UI sound for back button...');
                    playDataFetchedSound();

                    console.log('Navigating to index...');
                    // Navigate immediately while sound plays
                    window.location.href = backButton.getAttribute('href');
                });
            }

            // Add click handler to Deadlock logo (same sound as avatar)
            const deadlockLogo = document.querySelector('.dashboard-logo');
            if (deadlockLogo) {
                deadlockLogo.style.cursor = 'pointer';
                deadlockLogo.addEventListener('click', function() {
                    console.log('Deadlock logo clicked');
                    const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_friends_list_send_invite_02.mp3';
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => console.log('Logo sound started playing!'))
                        .catch(err => console.error('Failed to play logo sound:', err));
                });
            }

            // Add click handler to player avatar
            const playerAvatar = document.querySelector('.player-avatar');
            if (playerAvatar) {
                playerAvatar.style.cursor = 'pointer';
                playerAvatar.addEventListener('click', function() {
                    console.log('Player avatar clicked');
                    const soundUrl = 'https://assets-bucket.deadlock-api.com/assets-api-res/sounds/ui/ui_friends_list_send_invite_02.mp3';
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => console.log('Avatar sound started playing!'))
                        .catch(err => console.error('Failed to play avatar sound:', err));
                });
            }

            // Add click handlers to KPI tiles
            const kpiTiles = document.querySelectorAll('.summary-card');
            kpiTiles.forEach(function(tile) {
                tile.style.cursor = 'pointer';
                tile.addEventListener('click', function() {
                    console.log('KPI tile clicked, counter:', kpiSoundCounter);

                    // Wait for audio data to load if not ready
                    if (!soundsData || !soundsData.player || !soundsData.player.footsteps) {
                        console.log('Audio data not ready yet');
                        return;
                    }

                    // Navigate to player.footsteps.shared.surface_sweeteners.soft_impact
                    const footsteps = soundsData.player.footsteps;
                    if (!footsteps.shared || !footsteps.shared.surface_sweeteners || !footsteps.shared.surface_sweeteners.soft_impact) {
                        console.log('Footstep sounds not found in expected path');
                        return;
                    }

                    const softImpactSounds = footsteps.shared.surface_sweeteners.soft_impact;

                    // Find the dirt sound with current counter number (two-digit format)
                    const soundKey = `dirt_${String(kpiSoundCounter).padStart(2, '0')}`;
                    const soundUrl = softImpactSounds[soundKey];

                    if (!soundUrl) {
                        console.log('Sound not found:', soundKey);
                        // Try to find any dirt sounds to debug
                        const dirtSounds = Object.keys(softImpactSounds).filter(k => k.startsWith('dirt_'));
                        console.log('Available dirt sounds:', dirtSounds);
                        return;
                    }

                    console.log('Playing sound:', soundKey);
                    const audio = new Audio(soundUrl);
                    audio.volume = globalVolume;
                    audio.play()
                        .then(() => {
                            console.log('KPI sound started playing!');
                            // Increment counter
                            kpiSoundCounter++;
                            if (kpiSoundCounter > 14) {
                                kpiSoundCounter = 1; // Reset to 1
                            }
                        })
                        .catch(err => console.error('Failed to play KPI sound:', err));
                });
            });

            // Hide loading overlay if back button is used
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    loadingOverlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
