<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Analysis - {{ match_id }}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Detailed match breakdown and team performance analysis for Deadlock match {{ match_id }}.">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/match.css') }}">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Applying filter...</div>
    </div>

    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="match-info-card">
                <div class="match-info-layout">
                    <!-- Left: Title + Match Details -->
                    <div class="match-info-left">
                        <h1>Match Analysis</h1>
                        {% if match_summary %}
                        <div class="match-details">
                            <div class="match-date">
                                <span class="date-text">{{ match_summary.start_date_formatted }}</span>
                            </div>
                            <div class="match-id">
                                <span class="label">Match ID:</span>
                                <span class="value">{{ match_summary.match_id }}</span>
                                <button class="copy-btn" onclick="copyMatchId()">Copy</button>
                            </div>
                            <div class="match-meta">
                                <div class="meta-item">
                                    <span class="label">Duration:</span>
                                    <span class="value">{{ match_summary.duration_formatted }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="label">Game Mode:</span>
                                    <span class="value">{{ match_summary.game_mode }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Center: Team Comparison -->
                    {% if team_stats %}
                    <div class="match-info-center">
                    <div class="team-comparison">
                    <!-- Left Logo -->
                    <div class="team-logo-col team-logo-left">
                        {% if match_summary.patron_logo_team0 %}
                        <img src="{{ match_summary.patron_logo_team0 }}" alt="Archmother" class="patron-logo">
                        {% endif %}
                        {% if match_summary.rank_badge_team0 %}
                        <img src="{{ match_summary.rank_badge_team0 }}" alt="Team Rank" class="rank-badge rank-badge-left">
                        {% endif %}
                        {% if match_summary.winning_team == 1 %}
                        <span class="victory-badge">Victory</span>
                        {% elif match_summary.winning_team == 0 %}
                        <span class="defeat-badge">Defeat</span>
                        {% endif %}
                    </div>

                    <!-- Stats Grid -->
                    <div class="compare-grid">
                        <div class="compare-value team-blue"><span {% if team_stats.best.get('kills') == 'team1' %}class="stat-best"{% endif %}>{{ team_stats.team1.kills }}</span></div>
                        <div class="compare-label">Kills</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('kills') == 'team0' %}class="stat-best"{% endif %}>{{ team_stats.team0.kills }}</span></div>

                        <div class="compare-value team-blue"><span {% if team_stats.best.get('deaths') == 'team1' %}class="stat-best"{% endif %}>{{ team_stats.team1.deaths }}</span></div>
                        <div class="compare-label">Deaths</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('deaths') == 'team0' %}class="stat-best"{% endif %}>{{ team_stats.team0.deaths }}</span></div>

                        <div class="compare-value team-blue"><span {% if team_stats.best.get('assists') == 'team1' %}class="stat-best"{% endif %}>{{ team_stats.team1.assists }}</span></div>
                        <div class="compare-label">Assists</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('assists') == 'team0' %}class="stat-best"{% endif %}>{{ team_stats.team0.assists }}</span></div>

                        <div class="compare-value team-blue"><span {% if team_stats.best.get('net_worth') == 'team1' %}class="stat-best"{% endif %}>{% if team_stats.team1.net_worth >= 1000 %}{{ (team_stats.team1.net_worth / 1000) | round | int }}k{% else %}{{ team_stats.team1.net_worth }}{% endif %}</span></div>
                        <div class="compare-label">Net Worth</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('net_worth') == 'team0' %}class="stat-best"{% endif %}>{% if team_stats.team0.net_worth >= 1000 %}{{ (team_stats.team0.net_worth / 1000) | round | int }}k{% else %}{{ team_stats.team0.net_worth }}{% endif %}</span></div>

                        <div class="compare-value team-blue"><span {% if team_stats.best.get('player_damage') == 'team1' %}class="stat-best"{% endif %}>{% if team_stats.team1.player_damage >= 1000 %}{{ (team_stats.team1.player_damage / 1000) | round | int }}k{% else %}{{ team_stats.team1.player_damage }}{% endif %}</span></div>
                        <div class="compare-label">Player Damage</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('player_damage') == 'team0' %}class="stat-best"{% endif %}>{% if team_stats.team0.player_damage >= 1000 %}{{ (team_stats.team0.player_damage / 1000) | round | int }}k{% else %}{{ team_stats.team0.player_damage }}{% endif %}</span></div>

                        <div class="compare-value team-blue"><span {% if team_stats.best.get('ability_points') == 'team1' %}class="stat-best"{% endif %}>{{ team_stats.team1.ability_points }}</span></div>
                        <div class="compare-label">Ability Points</div>
                        <div class="compare-value team-orange"><span {% if team_stats.best.get('ability_points') == 'team0' %}class="stat-best"{% endif %}>{{ team_stats.team0.ability_points }}</span></div>
                    </div>

                    <!-- Right Logo -->
                    <div class="team-logo-col team-logo-right">
                        {% if match_summary.patron_logo_team1 %}
                        <img src="{{ match_summary.patron_logo_team1 }}" alt="Hidden King" class="patron-logo">
                        {% endif %}
                        {% if match_summary.rank_badge_team1 %}
                        <img src="{{ match_summary.rank_badge_team1 }}" alt="Team Rank" class="rank-badge rank-badge-right">
                        {% endif %}
                        {% if match_summary.winning_team == 0 %}
                        <span class="victory-badge">Victory</span>
                        {% elif match_summary.winning_team == 1 %}
                        <span class="defeat-badge">Defeat</span>
                        {% endif %}
                    </div>
                </div>
                    </div>
                    {% endif %}

                    <!-- Right: Button -->
                    <div class="match-info-right">
                        <a href="/?mode=match" class="back-button">Analyze Another Match</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Badge -->
        {% if filtered_player_info %}
        <div class="filter-banner">
            <span class="filter-text">Viewing: {{ filtered_player_info.hero_name }} ({{ filtered_player_info.account_id }})</span>
            <a href="/match-analysis?match_id={{ match_id }}" class="clear-filter-btn">Clear Filter</a>
        </div>
        {% endif %}

        <!-- Player Scoreboard -->
        {% if player_scoreboard %}
        <div class="scoreboard-section">
            <h2>Player Scoreboard</h2>
            <div class="table-container">
                <table class="scoreboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Slot</th>
                            <th onclick="sortTable(1)">Team</th>
                            <th onclick="sortTable(2)">Hero</th>
                            <th onclick="sortTable(3)">Account ID</th>
                            <th onclick="sortTable(4)">K</th>
                            <th onclick="sortTable(5)">D</th>
                            <th onclick="sortTable(6)">A</th>
                            <th onclick="sortTable(7)">Net Worth</th>
                            <th onclick="sortTable(8)">Last Hits</th>
                            <th onclick="sortTable(9)">Denies</th>
                            <th onclick="sortTable(10)">Player Dmg</th>
                            <th onclick="sortTable(11)">Obj Dmg</th>
                            <th onclick="sortTable(12)">Healing</th>
                            <th class="items-header no-sort">Items (End Game)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in player_scoreboard %}
                        <tr class="player-row team-{{ player.team }} {% if player_slot and player.player_slot == player_slot %}filtered-player{% endif %}"
                            onclick="filterByPlayer({{ player.player_slot }})">
                            <td>{{ player.player_slot }}</td>
                            <td class="team-cell">
                                {% if player.team == 0 %}
                                    {% if match_summary.patron_logo_team0 %}
                                    <img src="{{ match_summary.patron_logo_team0 }}" alt="Archmother" class="team-logo-small" title="Archmother">
                                    {% else %}
                                    Archmother
                                    {% endif %}
                                {% else %}
                                    {% if match_summary.patron_logo_team1 %}
                                    <img src="{{ match_summary.patron_logo_team1 }}" alt="Hidden King" class="team-logo-small" title="Hidden King">
                                    {% else %}
                                    Hidden King
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <div class="hero-cell">
                                    {% if player.hero_icon %}
                                    <img src="{{ player.hero_icon }}" alt="{{ player.hero_name }}" class="hero-icon-small">
                                    {% endif %}
                                    <span>{{ player.hero_name }}</span>
                                    {% if player.mvp_rank == 1 %}
                                    <span class="mvp-badge" title="MVP">★</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ player.account_id }}</td>
                            <td class="kills"><span {% if 'kills' in player.best_stats %}class="stat-best"{% endif %}>{{ player.kills }}</span></td>
                            <td class="deaths"><span {% if 'deaths' in player.best_stats %}class="stat-best"{% endif %}>{{ player.deaths }}</span></td>
                            <td class="assists"><span {% if 'assists' in player.best_stats %}class="stat-best"{% endif %}>{{ player.assists }}</span></td>
                            <td><span {% if 'net_worth' in player.best_stats %}class="stat-best"{% endif %}>{% if player.net_worth >= 1000 %}{{ (player.net_worth / 1000) | round | int }}k{% else %}{{ player.net_worth }}{% endif %}</span></td>
                            <td><span {% if 'last_hits' in player.best_stats %}class="stat-best"{% endif %}>{% if player.last_hits >= 1000 %}{{ (player.last_hits / 1000) | round | int }}k{% else %}{{ player.last_hits }}{% endif %}</span></td>
                            <td><span {% if 'denies' in player.best_stats %}class="stat-best"{% endif %}>{% if player.denies >= 1000 %}{{ (player.denies / 1000) | round | int }}k{% else %}{{ player.denies }}{% endif %}</span></td>
                            <td><span {% if 'player_damage' in player.best_stats %}class="stat-best"{% endif %}>{% if player.player_damage >= 1000 %}{{ (player.player_damage / 1000) | round | int }}k{% else %}{{ player.player_damage }}{% endif %}</span></td>
                            <td><span {% if 'boss_damage' in player.best_stats %}class="stat-best"{% endif %}>{% if player.boss_damage >= 1000 %}{{ (player.boss_damage / 1000) | round | int }}k{% else %}{{ player.boss_damage }}{% endif %}</span></td>
                            <td class="healing"><span {% if 'player_healing' in player.best_stats %}class="stat-best"{% endif %}>{% if player.player_healing >= 1000 %}{{ (player.player_healing / 1000) | round | int }}k{% else %}{{ player.player_healing }}{% endif %}</span></td>
                            <td class="items-cell">
                                {% if player.final_items %}
                                    {% for item in player.final_items %}
                                    <img src="{{ item.icon }}" alt="{{ item.name }}" class="item-icon" title="{{ item.name }}">
                                    {% endfor %}
                                {% else %}
                                    <span class="no-items">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        // Copy match ID to clipboard
        function copyMatchId() {
            const matchId = "{{ match_id }}";
            navigator.clipboard.writeText(matchId).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        // Filter by player
        function filterByPlayer(playerSlot) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');

            // Navigate to filtered view
            window.location.href = `/match-analysis?match_id={{ match_id }}&player_slot=${playerSlot}`;
        }

        // Table sorting
        let sortDirection = 1;
        let lastSortedColumn = -1;

        function sortTable(columnIndex) {
            const table = document.querySelector('.scoreboard-table tbody');
            const rows = Array.from(table.querySelectorAll('tr'));

            // Toggle direction if clicking same column
            if (lastSortedColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                sortDirection = 1;
                lastSortedColumn = columnIndex;
            }

            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.replace(/,/g, '').trim();
                let bValue = b.cells[columnIndex].textContent.replace(/,/g, '').trim();

                // Handle "k" suffix (thousands)
                if (aValue.endsWith('k')) {
                    aValue = parseFloat(aValue.slice(0, -1)) * 1000;
                }
                if (bValue.endsWith('k')) {
                    bValue = parseFloat(bValue.slice(0, -1)) * 1000;
                }

                // Try numeric comparison first
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return (aNum - bNum) * sortDirection;
                }

                // Fall back to string comparison
                return aValue.toString().localeCompare(bValue.toString()) * sortDirection;
            });

            // Reorder rows
            rows.forEach(row => table.appendChild(row));
        }

        // Apply Steam theme to all charts
        function applySteamTheme(chart) {
            chart.layout.paper_bgcolor = 'rgba(0, 0, 0, 0)';
            chart.layout.plot_bgcolor = 'rgba(22, 32, 45, 0.4)';
            chart.layout.font = { color: '#c7d5e0', family: 'Motiva Sans, Arial', size: 12 };

            if (chart.layout.xaxis) {
                chart.layout.xaxis.gridcolor = '#3d4e5c';
                chart.layout.xaxis.zerolinecolor = '#3d4e5c';
            }
            if (chart.layout.yaxis) {
                chart.layout.yaxis.gridcolor = '#3d4e5c';
                chart.layout.yaxis.zerolinecolor = '#3d4e5c';
            }

            if (chart.layout.title) {
                chart.layout.title.font = { color: '#66c0f4', size: 22 };
            }

            return chart;
        }

        // Charts will be rendered here in future iterations

        // Hide loading overlay on page show (for back button)
        window.addEventListener('pageshow', function(event) {
            document.getElementById('loadingOverlay').classList.remove('active');
        });
    </script>
</body>
</html>
