# Claude Code Configuration for Deadlock Analytics

## Project Overview
This is a Python-based analytics project for analyzing Deadlock game data using the official Deadlock API. The project includes both a Flask web application for interactive data visualization and Marimo notebooks for exploratory analysis.

## Development Environment
- **Python version**: 3.12+ (managed by .python-version)
- **Package manager**: uv (fast Python package installer)
- **Virtual environment**: .venv
- **Web framework**: Flask
- **Visualization**: Plotly (interactive charts)
- **Data processing**: pandas
- **Notebook tool**: marimo (reactive notebooks)

## Code Style Guidelines
- Follow PEP 8 for Python code
- Use type hints where appropriate
- Keep functions focused and modular
- Use meaningful variable names (e.g., `df_match_history` not `df1`)

## Game-Specific Terminology
- **Souls**: In-game currency (NOT "Gold")
- **Net Worth**: Total Souls earned by a player
- **KDA**: Kills, Deaths, Assists
- **Hero**: Playable character
- **Match Result**: 0 or 1 (compare with player_team to determine win/loss)

## API Information
- **Data API**: api.deadlock-api.com
- **Assets API**: assets.deadlock-api.com
- **Documentation**:
  - Scalar: https://assets.deadlock-api.com/scalar
  - OpenAPI: https://api.deadlock-api.com/docs
- **Schema Reference**: See `/docs/api_schema_reference.md`

## Project Structure
```
deadlock-analytics/
├── app.py                      # Main Flask application
├── templates/                  # HTML templates for Flask
│   ├── index.html             # Landing page with player ID input and loading spinner
│   └── results.html           # Analytics dashboard with 7 charts
├── static/                     # Static assets
│   ├── fonts/                 # Custom fonts
│   │   └── ForevsDemo-*.otf  # ForevsDemo font family (14 variants)
│   └── img/
│       ├── minimap.png        # Deadlock minimap (512x512)
│       ├── graphic_cityscape.png  # Banner image for README
│       ├── deadlock-logo-no-title-flat.png  # Deadlock logo (flat)
│       └── Deadlock-icon-no-title.webp      # Deadlock icon
├── scripts/                    # Analysis scripts
│   ├── deadlock_notebook.py  # Original marimo notebook
│   └── analyze_schema.py     # API schema analysis tool
├── docs/                       # Documentation
│   └── api_schema_reference.md # API endpoint schemas
├── __marimo__/                # Marimo notebook cache
├── .venv/                     # Virtual environment
├── README.md                  # Project readme with cityscape banner
├── pyproject.toml             # Dependencies
└── uv.lock                    # Locked dependency versions
```

## Flask Web Application

### Running the App
```bash
source .venv/bin/activate
python app.py
# Visit http://localhost:5000
```

### Features
The Flask app provides an interactive analytics dashboard with:

**Header Section:**
- Player profile with Steam avatar (120x120px), username, and rank badge (left-justified text)
- Rank badge (48x48px) with hover tooltip showing rank name and tier
- Deadlock logo (center, 125px width, opacity transition effect)
- "Analyze Another Player" button (right)
- 5 KPI tiles: Total Matches, Wins, Losses, Win Rate, Avg K/D/A

**Top 5 Heroes:**
- Card grid showing most-played heroes with icons, match count, and win rate
- Hero icons from `/v2/heroes` endpoint (flattened image columns)

**Charts:**
1. **Number of Matches Played** - Histogram showing win/loss distribution over time
2. **Performance Curve** - Cumulative metrics over game time with dropdown selector:
   - Net Worth (Souls), Kills, Deaths, Assists
   - Dynamically updates title: "Cumulative {Metric} Over Game Time"
3. **Community Distribution Comparison** - Normal distribution with dropdown selector:
   - Blue curve: Community distribution (estimated from percentiles)
   - Colored dotted lines: Community percentiles (P10, P25, P50, P75, P90)
   - Green bold line: Player's average
   - Dynamically updates title: "{Metric} Compared To Community Distribution"
4. **Kill and Death Locations** - Scatter plot overlaid on minimap (600x600px, centered, bottom of page)
   - Legend positioned in top right inside chart
5. **MMR History** - 7-day rolling average showing MMR progression over time
   - Dual Y-axis: MMR (left) and Rank tier (right)
6. **KDA Trend Over Time** - 7-day rolling average with raw data scatter points
   - Hover only works on average lines, not scatter points

### Key Endpoints
- `/` - Home page with player ID input
- `/analyze` (POST) - Generate analytics for a player

## Data Flow

1. **User Input**: Player enters SteamID3 format player ID (e.g., 199540209)
2. **API Calls**: Flask app fetches data from 9 endpoints:
   - `/v2/heroes` - Hero names and metadata (includes images via flattened columns)
   - `/v1/players/{id}/match-history` - Match details
   - `/v1/players/steam-search?search_query={id}` - Steam profile (username, avatar)
   - `/v1/analytics/player-stats/metrics?account_id={id}` - Player statistics with community percentiles (use singular)
   - `/v1/analytics/player-performance-curve` - Performance over game time
   - `/v1/analytics/kill-death-stats` - Spatial kill/death data
   - `/v1/players/{id}/mmr-history` - MMR progression with division and tier
   - `/v2/ranks` - Rank metadata including badge images
   - `/v1/images` - Asset images (heroes, items, abilities)
3. **Data Processing**: pandas DataFrames with joins and transformations
4. **Steam Profile Filtering**: Filter steam-search results by matching account_id
5. **Top Heroes Calculation**: Group by hero_name, calculate matches and win rate
6. **Rank Badge Extraction**: Use latest game's division and division_tier
7. **Visualization**: Plotly charts rendered in browser with Steam theme
8. **Display**: Interactive dashboard with player profile, rank badge, top heroes, and charts

## Important Implementation Details

### Match Result Logic
```python
# Win determination
df['result'] = df.apply(
    lambda row: 'Win' if row['player_team'] == row['match_result'] else 'Loss',
    axis=1
)
```

### Time-Based Rolling Average
```python
# 7-day rolling window
df['kills_avg'] = df['player_kills'].rolling(window='7D', min_periods=1).mean()
```

### Hero Name Joins
```python
# Match history needs hero names
df_match = pd.merge(
    df_match_history,
    df_heroes[['id', 'name']],
    left_on='hero_id',
    right_on='id',
    how='left'
)
```

### Minimap Overlay
- Map coordinates range from approximately -10,000 to 10,000
- Minimap image positioned at full coordinate range
- Scatter markers overlaid using Scattergl for performance

### Steam Profile Integration
```python
# Fetch Steam profile data
steam_profile = get_request_data(connection, "data-api", "steam_search")

# Filter by account_id to get correct player
for profile in steam_profile:
    if str(profile.get('account_id', '')) == str(player_id):
        steam_data = {
            'username': profile.get('personaname', 'Unknown Player'),
            'avatar_full': profile.get('avatarfull', ''),
        }
```

### Rank Badge Integration
```python
# Get latest game's rank info
df_mmr = pd.json_normalize(mmr_data)
latest_game = df_mmr.iloc[-1]
division = latest_game.get('division')  # Tier (0-11)
division_tier = latest_game.get('division_tier', 0)  # Subrank (1-6)

# Match with ranks endpoint to get badge image
for rank in ranks_data:
    if rank.get('tier') == division:
        images = rank.get('images', {})
        badge_key = f'small_subrank{division_tier}' if division_tier > 0 else 'small'
        rank_badge_url = images.get(badge_key) or images.get('small')
```

### Top 5 Heroes Calculation
```python
# Group by hero_name and calculate stats
hero_stats = df_match_history.groupby('hero_name').agg({
    'match_id': 'count',  # Total matches
    'result': lambda x: (x == 'Win').sum()  # Total wins
}).rename(columns={'match_id': 'matches', 'result': 'wins'})

# Calculate win rate and sort
hero_stats['win_rate'] = (hero_stats['wins'] / hero_stats['matches'] * 100).round(1)
hero_stats = hero_stats.sort_values('matches', ascending=False).head(5)

# Get hero icons from flattened heroes endpoint columns
for img_key in ['images.icon_hero_card', 'images.icon_image_small']:
    if img_key in hero_row.index and pd.notna(hero_row[img_key]):
        icon_url = hero_row[img_key]
```

### Dynamic Chart Titles
```python
# Performance Curve dropdown updates title dynamically
'title.text': f"Cumulative {metric['name']} Over Game Time"

# Community Distribution chart dropdown updates title dynamically
'title.text': f"{metric['name']} Compared To Community Distribution"
```

### Community Distribution Chart
**IMPORTANT**: The distribution chart shows the player's performance compared to community distribution:
```python
# Use P50 (median) as community mean
community_mean = percentiles.get(50, player_avg)

# Estimate std from IQR for curve visualization
iqr = percentiles[75] - percentiles[25]
community_std = iqr / 1.35

# Generate normal distribution curve
x_range = np.linspace(community_mean - 4*community_std, community_mean + 4*community_std, 300)
y_range = stats.norm.pdf(x_range, community_mean, community_std)
```

**Percentiles Displayed**: P10, P25, P50, P75, P90 (P1, P5, P95, P99 removed for clarity)
- Each percentile is shown as a colored dotted vertical line
- Player's average shown as green bold line for comparison

### Steam Theme Styling
- Dark blue gradients: `#1b2838`, `#16202d`, `#2a475e`
- Steam blue highlights: `#66c0f4`
- Font: Motiva Sans (Steam's official font)
- Chart titles: 22px, Steam blue (#66c0f4)
- Container max-width: 1200px
- Header padding: 50px
- Chart heights: 600px for distribution chart
- Deadlock logo: 125px width, 120px height, opacity transition (0.6 → 1.0 on hover)
- Loading spinner: Full-screen overlay with Steam-themed spinner and glow effect
- Player profile text: Left-justified username and Steam ID
- Rank badge: 48x48px with tooltip on hover
- JavaScript `applySteamTheme()` function preserves chart properties while applying colors

## Dependencies
- **Flask**: Web framework
- **Plotly**: Interactive visualizations
- **pandas**: Data manipulation
- **numpy**: Numerical computing for distribution calculations
- **scipy**: Statistical functions (stats.norm.pdf for distribution curves)
- **marimo**: Reactive notebooks
- **deadlock-api-client**: Official API client (from Git)

Add new dependencies:
```bash
uv add <package-name>
```

## Testing
- Test API calls with `scripts/analyze_schema.py`
- Verify chart data by checking terminal debug output
- Use sample player ID: 199540209

## Common Tasks

### Add a new chart
1. Fetch data in `create_visualizations()` function
2. Create Plotly figure object
3. Add to `charts` dictionary with unique key
4. Add HTML container in `results.html`
5. Add Plotly rendering code in JavaScript section

### Modify existing chart
1. Update chart creation in `app.py`
2. Adjust layout, colors, or data transformations
3. Test with sample player ID
4. Check browser console for JavaScript errors

### Update API endpoints
1. Modify endpoint URLs in `get_api_connection()`
2. Update data fetching in `create_visualizations()`
3. Update schema documentation in `/docs/`

## Troubleshooting

### Charts not displaying
- Check terminal for debug output (print statements)
- Verify data shape and columns
- Check browser console for errors
- Ensure `.tolist()` is called when passing data to Plotly

### API errors
- Verify player ID format (SteamID3)
- Check API status at deadlock-api.com
- Review rate limits
- Check terminal for HTTP status codes

### Minimap not loading
- Verify `/static/img/minimap.png` exists
- Check file permissions
- Verify Flask static folder configuration
- Test URL: http://localhost:5000/static/img/minimap.png

## Documentation

### README.md
The project includes a comprehensive README with:
- **Banner Image**: Cityscape graphic (`static/img/graphic_cityscape.png`) displayed at full width
- **Quick Start Guide**: Installation and setup instructions using `uv`
- **Features List**: Overview of all dashboard capabilities
- **Technology Stack**: Key libraries and frameworks
- **Project Structure**: Directory layout
- **API Documentation Links**: References to Deadlock API resources

### Custom Fonts
- **ForevsDemo** font family (14 variants) in `static/fonts/`
- Installed system-wide with: `cp static/fonts/*.otf ~/.local/share/fonts/ && fc-cache -fv`
- Font family name: "Forevs Demo"
- Available styles: Regular, Bold, Black, Medium, Light, Thin, Super (with Italic variants)

## Important API Notes

### Use Singular Parameter
```python
# CORRECT
endpoint = f"/v1/analytics/player-stats/metrics?account_id={player_id}"

# INCORRECT (returns wrong data)
endpoint = f"/v1/analytics/player-stats/metrics?account_ids={player_id}"
```

### Hero Icon Sources
- Use flattened columns from `/v2/heroes` endpoint: `images.icon_hero_card`, `images.icon_image_small`, etc.
- Class names don't always match image names (e.g., "Mina" → "vampirebat")
- Don't rely on `/v1/images` endpoint for hero matching by name
